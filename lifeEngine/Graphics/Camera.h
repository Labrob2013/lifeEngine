//////////////////////////////////////////////////////////////////////////
// 
//			*** lifeEngine (Двигатель Жизни) ***
//					Copyright (C) 2017
//
// Связь со мной:		https://vk.com/zombihello
// Репозиторий движка:  https://github.com/zombihello/lifeEngine
// 
//////////////////////////////////////////////////////////////////////////

#ifndef CAMERA_H
#define CAMERA_H

#define COMPILING_LIBRARY
#include <DllGlobal.h>

//////////////
// OPENGL
//////////////
#include <glm\glm.hpp>

//////////////////
// SFML
//////////////////
#include <SFML\Graphics.hpp>
using namespace sf;

//////////////////
// LIFEENGINE
//////////////////
#include <System\System.h>
#include <Graphics\Frustum.h>

namespace le
{
	//-------------------------------------------------------------------------//

	class BoundingBox;

	//-------------------------------------------------------------------------//

	//////////////////////////////////////////////////////////////////////
	/// \brief Класс для работы с камерой
	//////////////////////////////////////////////////////////////////////
	class DLL_API Camera
	{
	public:

		//-------------------------------------------------------------------------//

		enum TypeMove
		{
			Forward,
			Back,
			Left,
			Right
		};

		//-------------------------------------------------------------------------//

		//////////////////////////////////////////////////////////////////////
		/// \brief Конструктор
		//////////////////////////////////////////////////////////////////////
		Camera( System& System );

		//////////////////////////////////////////////////////////////////////
		/// \brief Деструктор
		//////////////////////////////////////////////////////////////////////
		~Camera();

		//////////////////////////////////////////////////////////////////////
		/// \brief Обновить точку взгляда в зависимости от положения мышки
		//////////////////////////////////////////////////////////////////////
		void UpdateTargetPoint();

		//////////////////////////////////////////////////////////////////////
		/// \brief Обновить видовую матрицу
		//////////////////////////////////////////////////////////////////////
		void UpdateViewMatrix();

		//////////////////////////////////////////////////////////////////////
		/// \brief Сместить камеру
		/// \details Данный метод перемещает камеру
		///
		/// \param[in] FactorMove Фактор смещение (на сколько сместить)
		//////////////////////////////////////////////////////////////////////
		void Move( const glm::vec3& FactorMove );

		//////////////////////////////////////////////////////////////////////
		/// \brief Сместить камеру
		/// \details Данный метод перемещает камеру с учетом ее поворота
		///
		/// \param[in] typeMove Тип движения (Влево, Вправо и т.д)
		/// \param[in] MoveSpeed Скорость перемещения
		//////////////////////////////////////////////////////////////////////
		void Move( TypeMove TypeMove, float MoveSpeed );

		//////////////////////////////////////////////////////////////////////
		/// \brief Наклонить камеру по оси Z
		/// \details Данный метод наклоняет камеру по Z
		///
		/// \param[in] FactorTilt Фактор наклона
		//////////////////////////////////////////////////////////////////////
		void TiltCamera( float FactorTilt );

		//////////////////////////////////////////////////////////////////////
		/// \brief Задать чуствительность мыши
		///
		/// \param[in] SensitivityMouse Чуствительность мыши
		//////////////////////////////////////////////////////////////////////
		static void SetSensitivityMouse( float SensitivityMouse );

		//////////////////////////////////////////////////////////////////////
		/// \brief Задать ось вверх
		///
		/// \param[in] AxisVertical Ось вверх
		//////////////////////////////////////////////////////////////////////
		void SetAxisVertical( const glm::vec3& AxisVertical );

		//////////////////////////////////////////////////////////////////////
		/// \brief Задать позицию мыши
		///
		/// \param[in] NewPosition Новая позиция
		//////////////////////////////////////////////////////////////////////
		void SetPosition( const glm::vec3& NewPosition );

		//////////////////////////////////////////////////////////////////////
		/// \brief Задать точку взгляда
		///
		/// \param[in] TargetPoint Точка взгляда
		//////////////////////////////////////////////////////////////////////
		void SetTargetPoint( const glm::vec3& TargetPoint );

		//////////////////////////////////////////////////////////////////////
		/// \brief Задать наклонение камеры по Z
		///
		/// \param[in] InclinationCamera Наклон камеры
		//////////////////////////////////////////////////////////////////////
		void SetInclinationCamera( float InclinationCamera );

		//////////////////////////////////////////////////////////////////////
		/// \brief Получить ось вверх
		///
		/// \return Ось вверх
		//////////////////////////////////////////////////////////////////////
		glm::vec3& GetAxisVertical();

		//////////////////////////////////////////////////////////////////////
		/// \brief Получить позицию камеры
		///
		/// \return Позиция камеры
		//////////////////////////////////////////////////////////////////////
		glm::vec3& GetPosition();

		//////////////////////////////////////////////////////////////////////
		/// \brief Получить точку взгляда
		///
		/// \return Точка взгляда
		//////////////////////////////////////////////////////////////////////
		glm::vec3& GetTargetPoint();

		//////////////////////////////////////////////////////////////////////
		/// \brief Получить наклон камеры по Z
		///
		/// \return Наклон камеры
		//////////////////////////////////////////////////////////////////////
		float GetInclinationCamera();

		//////////////////////////////////////////////////////////////////////
		/// \brief Получить растояние до точки
		///
		/// \param[in] PositionObject Позиция точки
		/// \return Расстояние между точками
		//////////////////////////////////////////////////////////////////////
		inline float GetDistance( const glm::vec3& PositionObject );

		//////////////////////////////////////////////////////////////////////
		/// \brief Получить вектор смещения
		/// \details Возвращает смещение XYZ с учетом поворота камеры
		///
		/// \param[in] typeMove Тип движения (Влево, Вправо и т.д)
		/// \param[in] MoveSpeed Скорость перемещения
		/// \return Вектор смещения
		//////////////////////////////////////////////////////////////////////
		glm::vec3 GetVectorMove( TypeMove typeMove, float MoveSpeed );

		//////////////////////////////////////////////////////////////////////
		/// \brief Получить видовую матрицу камеры
		///
		/// \return Видовая матрица камеры
		//////////////////////////////////////////////////////////////////////
		glm::mat4& GetViewMatrix();

		//////////////////////////////////////////////////////////////////////
		/// \brief Получить усеченную пирамиду видимости
		///
		/// \return Усеченная пирамида видимости
		//////////////////////////////////////////////////////////////////////
		Frustum& GetFrustum();

	private:

		bool					IsUpdate;						///< Нуждается ли камера в обновлении видовой матрицы
		float					InclinationCamera;				///< Наклон камеры
		static float			SensitivityMouse;				///< Чуствительность мыши

		glm::vec2				Angle;							///< Угол поворота камеры
		glm::vec3				Position;						///< Позиция камеры
		glm::vec3				TargetPoint;					///< Точка взгляда
		glm::vec3				AxisVertical;					///< Ось вверх
		glm::vec3				Direction;						///< Направление камеры		
		glm::vec3				CameraRight;					///< Вектор вправо
		glm::mat4				ViewMatrix;						///< Матрица вида
		glm::mat4*				ProjectionMatrix;				///< Матрица проекции
		glm::mat4				InclinationCameraMatrix;		///< Матрица наклона камеры
		Frustum					Frustum;						///< Усеченная пирамида видимост (для отсечения невидимой геометрии)

		RenderWindow*			RenderWindow;					///< Игровое окно
		Vector2i				CenterWindow;					///< Центр окна
		Vector2i				MousePosition;					///< Позиция мыши
	};

	//-------------------------------------------------------------------------//
}

#endif //CAMERA_H